version: 2.1

orbs:
    sam: circleci/aws-sam-serverless@3
    python: circleci/python@2.0.3

jobs:
    build:
        executor: sam/default
        steps:
            - checkout
            - sam/install
            - sam/build:
                  use-container: false
                  template: template.yaml
            - persist_to_workspace:
                  root: .
                  paths:
                      - .

    unit-test:
        executor: python/default
        steps:
            - checkout
            - python/dist
            - run: python3 -m pytest tests/unit -v

    deploy:
        executor: sam/default
        steps:
            - attach_workspace:
                  at: .
            - sam/install
            - sam/deploy:
                  stack-name: $CIRCLE_PROJECT_REPONAME
                  s3-bucket: $SAM_S3_BUCKET

workflows:
    lambda-python:
        jobs:
            - build:
                  context:
                      - build
                      - aws-credentials-context-dev
            - unit-test:
                  context:
                      - build
                      - aws-credentials-context-dev
                  requires:
                      - build
                  filters:
                      branches:
                          only: 
                            - master
                            - orb-lambda-python
            - deploy:
                  name: deploy-dev
                  context:
                      - aws-credentials-context-dev
                  requires:
                      - unit-test
                  filters:
                      branches:
                          only: 
                            - master
                            - orb-lambda-python
            - deploy:
                  name: deploy-qa
                  context:
                      - aws-credentials-context-qa
                  requires:
                      - deploy-dev
                  filters:
                      branches:
                          only: 
                            - master
                            - orb-lambda-python
            - approve-deploy-prod:
                  type: approval
                  requires:
                      - deploy-qa
            - deploy:
                  name: deploy-prod
                  context: aws-prod
                  requires:
                      - approve-deploy-prod