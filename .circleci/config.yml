version: '2.1'
orbs:
  sam: circleci/aws-sam-serverless@3.0
jobs:
  build_lambda:
    executor: sam/default
    steps:
      - checkout
      - sam/install
      - run: |          
          gradle build -x test
      - persist_to_workspace:
          root: .
          paths:
            - .
  unit_test:
    docker:
      - image: gradle
    steps:
      - attach_workspace:
          at: .
      - run: gradle test
workflows:
  kotlin-pipeline:
    jobs:
      - build_lambda:
          context: build
      - unit_test:
          context: build
          requires:
            - build_lambda
      - sam/deploy:
          context: aws-credentials-context-dev
          name: deploy-dev
          requires:
            - unit_test
          stack-name: alloy-eval-stack-dev
          template: template.yaml
      - sam/deploy:
          context: aws-credentials-context-test
          name: deploy-test
          requires:
            - deploy-dev
          stack-name: alloy-eval-stack-test
          template: template.yaml
      - approve-deploy-prod:
          type: approval
          requires:
            - deploy-test
      - sam/deploy:
          context: aws-credentials-context-prod
          name: deploy-prod
          requires:
            - approve-deploy-prod
          stack-name: alloy-eval-stack-prod
          template: template.yaml