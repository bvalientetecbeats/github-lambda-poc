version: 2.1

#CircleCI Orbs to use in this pipeline
orbs:
    sam: circleci/aws-sam-serverless@3.0
    #python@1.0.0 version supports pipenv
    python: circleci/python@1.0.0

jobs:
    #Build the app
    build:
        executor: sam/default
        steps:
            - checkout
            - sam/install
            - sam/build:
                  use-container: false
                  template: template.yaml
            - persist_to_workspace:
                  root: .
                  paths:
                      - .

    #Run the unit test
    unit-test:
        executor: python/default
        steps:
            - checkout
            #pip pytest package installation
            - python/install-packages:
                args: pytest
                pkg-manager: pipenv
            #Additional pip packages installation
            - run: pip install -r tests/requirements.txt --user
            #Run unit test under ./tests/ directory
            - run: python3 -m pytest tests/unit -v

    #Deployment with AWS SAM
    deploy:
        executor: sam/default
        steps:
            - attach_workspace:
                  at: .
            - sam/install
            - run: echo $SAM_S3_BUCKET
            - sam/deploy:
                  stack-name: $CIRCLE_PROJECT_REPONAME

workflows:
    lambda-python:
        jobs:
            - build:
                  context:
                      - build
                      - aws-credentials-context-dev
            - unit-test:
                  context:
                      - aws-credentials-context-dev
                  requires:
                      - build
                  filters:
                      branches:
                          only: 
                            - master
                            - orb-lambda-python
            - deploy:
                  name: deploy-dev
                  context:                      
                      - aws-credentials-context-dev
                  s3-bucket: $SAM_S3_BUCKET
                  requires:
                      - unit-test
                  filters:
                      branches:
                          only: 
                            - master
                            - orb-lambda-python
            - deploy:
                  name: deploy-qa
                  context:
                      - aws-credentials-context-test
                  requires:
                      - deploy-dev
                  filters:
                      branches:
                          only: 
                            - master
                            - orb-lambda-python
            - approve-deploy-prod:
                  type: approval
                  requires:
                      - deploy-qa
            - deploy:
                  name: deploy-prod
                  context: aws-credentials-context-dev
                  requires:
                      - approve-deploy-prod