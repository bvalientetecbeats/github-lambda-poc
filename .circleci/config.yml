version: 2
jobs:
  build-container-python:
    working_directory: /tmp/project/
    docker:
      - image: circleci/python:2.7.14
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: false
      - run:
          name: Build and push Docker image to ecr
          command: |
            set -e
            echo "Getting started with Docker image build..."
            sudo su
            apt-get -qq update -y && apt-get -qq install -y curl unzip
            echo "Configuring AWS CLI 2..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -qq awscliv2.zip
            ./aws/install
            aws --version
            echo "Setting up AWS credentials..."
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID_DEV
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY_DEV
            aws configure set default.region $AWS_DEFAULT_REGION
            aws s3 ls
            cd ./.build/
            echo 'export TAG=0.1.${CIRCLE_BUILD_NUM}' >> ${BASH_ENV}
            echo 'export IMAGE_NAME=${CIRCLE_PROJECT_REPONAME}' >> ${BASH_ENV}
            source ${BASH_ENV}
            docker build -t cicdtools:react-latest .
      - persist_to_workspace:
          root: .
          paths:
            - .
  deploy-ecs-dev:  
    working_directory: /tmp/project/
    docker:
      - image: $AWS_ACCOUNT_DEV.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/cicdtools:kotlin-latest
        aws_auth:
          aws_access_key_id: $AWS_ACCESS_KEY_ID_DEV
          aws_secret_access_key: $AWS_SECRET_ACCESS_KEY_DEV
    steps:
      - checkout
      - attach_workspace:
          at: .          
      - run:
          name: lambda-deployment
          command: |
            echo "Setting up environment..."
            TFVAR_environment='dev'
            echo "Setting up AWS credentials..."    
            AWS_PAGER=''
            aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID_DEV
            aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY_DEV
            aws configure set default.region $AWS_DEFAULT_REGION
            echo "Starting terraform init..."
            cd ./terraform-code/$TFVAR_environment/ecs
            terraform init
            echo "Starting terraform plan..."
            terraform plan -out tfapply
            echo "Starting terraform apply..."
            terraform apply -auto-approve tfapply
workflows:
  version: 2
  deploy-python-containerized:
    jobs:
      - build-container-python
      - deploy-ecs-dev:
          requires:
            - build-container-python