version: '2.1'

orbs:
  aws-cli: circleci/aws-cli@3.1

jobs:

  build:
    executor: docker
    docker:
      - image: 'cimg/base:stable'
    steps:
      - checkout
      - node/install:
          node-version: '16.15'
      - run:
            name: Node version
            command: node --version
      - restore_cache:
            keys:
              - v1-dependencies-{{ checksum "npm-shrinkwrap.json" }}
              #Fallback on empty cache
              - v1-dependencies-
      - run:
            name: Npm install
            command: npm ci
      - run:
            name: Npm build
            command: npm run build
      - save_cache:
          key: v1-dependencies-{{ checksum "npm-shrinkwrap.json" }}
          paths:
            - node_modules
      - persist_to_workspace:
          root: .
          paths:
            - '*' 

  infrastructure-amplify:
    executor: aws-cli/default
    steps:
      - attach_workspace:
          at: .
      - checkout
      - aws-cli/setup:
          profile-name: default
      - run: |
          set -e
          sudo npm install -g @aws-amplify/cli --unsafe-perm=true
          npx create-react-app amplify-app
          cd amplify-app
          amplify init -y 

workflows:
  aws-cli:
    jobs:
      - build:
          context: aws-credentials-context-dev
      - infrastructure-amplify:
          requires: 
              - build
          context: aws-credentials-context-dev