version: '2.1'
orbs:
  sam: circleci/aws-sam-serverless@3.0
jobs:
  build_lambda:
    executor: sam/default
    steps:
      - checkout
      - sam/install
      - run: |
          gradle build -x test
      - persist_to_workspace:
          root: .
          paths:
            - .
  unit_test:
    docker:
      - image: gradle
    steps:
      - attach_workspace:
          at: .
      - run: gradle test
workflows:
  kotlin-pipeline:
    jobs:
      #- build_lambda
      - unit_test
      #    requires:
      #      - build_lambda
      - sam/deploy:
          context: aws-credentials-context
          name: deploy-dev
          requires:
            - unit_test
          stack-name: dev-alloy-eval-stack
          template: ./template.yml