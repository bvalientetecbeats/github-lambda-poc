version: '2.1'
orbs:
  sam: circleci/aws-sam-serverless@3.0
jobs:
  build_lambda:
    executor: sam/default
    steps:
      - checkout
      - sam/install
      - run: |
          gradle build -x test
      - persist_to_workspace:
          root: .
          paths:
            - .
  unit_test:
    docker:
      - image: gradle
    steps:
      - attach_workspace:
          at: .
      - run: |
          gradle test
          ls -lah && pwd
workflows:
  kotlin-pipeline:
    jobs:
#      - build_lambda
#      - unit_test:
#          requires:
#            - build_lambda
      - sam/deploy:
          context: aws-credentials-context
          name: deploy-dev
          s3-bucket: aws-sam-cli-managed-default-samclisourcebucket-1ssa74km4w6q0
#          requires:
#            - unit_test
          stack-name: dev-alloy-eval-stack
          template: $CIRCLE_WORKING_DIRECTORY/template.yml