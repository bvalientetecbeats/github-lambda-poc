version: '2.1'

orbs:
  aws-cli: circleci/aws-cli@3.1
  node: circleci/node@5.0.2
 
jobs:

  #Provision AWS Amplify Infrastructure
  provision:
    executor: aws-cli/default
    steps:
      - checkout
      - aws-cli/setup:
          profile-name: default
      - run: |
          set -e
          sudo npm install -g @aws-amplify/cli --unsafe-perm=true
          amplify init -y
          amplify status
      - persist_to_workspace:
          root: .
          paths:
            - '*'

  #Build React app
  build:
    docker:
      - image: 'cimg/base:stable'
    steps:
      - attach_workspace:
          at: .
      - checkout
      - node/install:
          node-version: '16.15'
      - run:
            name: Node version
            command: node --version
      - restore_cache:
            keys:
              - v1-dependencies-{{ checksum "npm-shrinkwrap.json" }}
              #Fallback on empty cache
              - v1-dependencies-
      - run:
            name: Npm install
            command: npm ci
      - run:
            name: Npm build
            command: npm run build
      - save_cache:
          key: v1-dependencies-{{ checksum "npm-shrinkwrap.json" }}
          paths:
            - node_modules
      - persist_to_workspace:
          root: .
          paths:
            - '*'
  
  #Deploy react app to amplify
  deploy-amplify:
    executor: aws-cli/default
    steps:
      - attach_workspace:
          at: .
      - checkout
      - aws-cli/setup:
          profile-name: default
      - run: |
          set -e
          sudo npm install -g @aws-amplify/cli --unsafe-perm=true
          yes "" | amplify add hosting
          amplify publish
      - persist_to_workspace:
          root: .
          paths:
            - '*'

workflows:
  aws-cli:
    jobs:
      - provision:
          context: aws-credentials-context-dev
      - build:
          requires: 
              - provision
          context: aws-credentials-context-dev
      - deploy-amplify:
          name: deploy-amplify-dev
          requires:
              - build
          context: aws-credentials-context-dev
